name: deploy video-streaming server CI/CD pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: self-hosted
    env:
      MONGO_URL: ${{ secrets.MONGO_URL }}
      ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      ENDPOINT: ${{ secrets.ENDPOINT }}
      REGION: ${{ secrets.REGION }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      GOOGLE_CALLBACK_URL: ${{ secrets.GOOGLE_CALLBACK_URL }}
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
      REDIS_URL: ${{ secrets.REDIS_URL }}
      CLIENT_URL: ${{ secrets.CLIENT_URL }}
      REDIS_USERNAME: ${{ secrets.REDIS_USERNAME }}
      REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
      REDIS_HOST: ${{ secrets.REDIS_HOST }}
      REDIS_PORT: ${{ secrets.REDIS_PORT }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{matrix.node-version}}
        uses: actions/setup-node@v1
        with:
          node-version: ${{matrix.node-version}}
      - name: Print current directory and PATH
        run: |
          pwd
          echo $PATH
      - name: Install dependencies
        run: |
          npm install
          npm run build
      - name: Stop all PM2 processes and print PM2 logs
        run: |
          npm run start
          sudo systemctl restart nginx
